{% extends "layout.html" %}
{% block content %}

<h1 class="display-5 text-center mb-4">Agenda Deportiva</h1>
<p class="text-center text-muted mb-5">¡No te pierdas tus eventos favoritos!</p>

<!-- BUSCADOR + FILTRO -->
<div class="row g-3 align-items-center justify-content-center mb-4">

  <div class="col-lg-6">
    <input id="searchInput" class="form-control form-control-lg input-dark"
      placeholder="Buscar por equipo, liga o evento...">
  </div>

  <div class="col-lg-3">
    <select id="providerFilter" class="form-select form-select-lg input-dark">
      <option value="">Todas las opciones</option>
      <option value="Kakarotfoot">Opción 1</option>
      <option value="KevinSport">Opción 2</option>
      <option value="LiveTV">Opción 3</option>
      <option value="Tiroalpalo">Opción 4</option>
    </select>
  </div>

</div>

<!-- AGRUPAR POR PROVEEDOR -->
{% set grouped = events | groupby('provider') %}

{% for provider, items in grouped %}
<section class="provider-block mb-5" data-provider="{{ provider }}">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 mb-0 provider-badge provider-{{ provider|lower }}">
      {% if provider == 'Kakarotfoot' %}
      Opción 1
      {% elif provider == 'KevinSport' %}
      Opción 2
      {% elif provider == 'LiveTV' %}
      Opción 3
      {% elif provider == 'Tiroalpalo' %}
      Opción 4
      {% else %}
      {{ provider }}
      {% endif %}
    </h2>
    <small class="text-muted">{{ items|length }} partidos</small>
  </div>

  <div class="table-responsive shadow-sm rounded">
    <table class="table table-dark table-striped provider-table" data-page-size="10">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Partido</th>
          <th>Liga</th>
          <th class="text-end">Acción</th>
        </tr>
      </thead>

      <tbody>

        {% for event in items %}
        <tr>

          <!-- FECHA/HORA -->
          <td>
            {% if event.match_time %}
            <span class="badge" style="background: var(--accent-color); font-size: 0.9rem;">{{ event.match_time
              }}</span>
            {% elif event.date_text %}
            <span class="badge" style="background: var(--accent-color); font-size: 0.9rem;">{{ event.date_text }}</span>
            {% else %}
            <!-- fallback para Kakarotfoot -->
            <span class="badge" style="background: var(--accent-color); font-size: 0.9rem;">{{ event.start_time |
              datetime }}</span>
            {% endif %}
          </td>

          <!-- PARTIDO -->
          <td>
            <strong>{{ event.home }}</strong>
            {% if event.away %}
            <span class="text-danger mx-2">vs</span>
            <strong>{{ event.away }}</strong>
            {% endif %}
          </td>

          <!-- LIGA -->
          <td>
            <span class="text-muted small">{{ event.league or 'Sin información' }}</span>
          </td>

          <!-- BOTÓN VER STREAM -->
          <td class="text-end">

            <!-- Para LiveTV SIEMPRE debe ser lazy -->
            {% if provider.lower() == "livetv" %}
            <a href="/stream?event={{ event.id | urlencode }}&source=LiveTV" class="btn btn-primary btn-sm">
              Ver transmisión
            </a>

            {% else %}
            <!-- Otros sitios sí pueden tener streams -->
            {% if event.streams and event.streams|length > 0 %}
            <a href="/stream?url={{ event.streams[0].url | urlencode }}
                           &source={{ event.provider | urlencode }}
                           &event={{ event.id | urlencode }}" class="btn btn-primary btn-sm">
              Ver transmisión
            </a>
            {% endif %}
            {% endif %}

          </td>

        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>

  <!-- PAGINACIÓN -->
  <div class="pagination-controls d-flex justify-content-end gap-2 mt-3">
    <button class="btn btn-sm btn-outline-light prev-page">«</button>
    <span class="page-info small">Página 1</span>
    <button class="btn btn-sm btn-outline-light next-page">»</button>
  </div>

</section>
{% endfor %}

{% endblock %}