{% extends "layout.html" %}
{% block content %}

<h1 class="display-5 text-center mb-4">Sportstream</h1>

<!-- BUSCADOR + FILTRO -->
<div class="row g-3 align-items-center justify-content-center mb-4">

  <div class="col-lg-6">
    <input id="searchInput" class="form-control form-control-lg input-dark"
      placeholder="Buscar por equipo, liga o evento...">
  </div>

  <div class="col-lg-3">
    <select id="providerFilter" class="form-select form-select-lg input-dark">
      <option value="">Todos los sitios</option>

      {% set providers = events | map(attribute='provider') | list %}
      {% for p in providers | unique %}
      <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>
  </div>

</div>

<!-- AGRUPAR POR PROVEEDOR -->
{% set grouped = events | groupby('provider') %}

{% for provider, items in grouped %}
<section class="provider-block mb-5" data-provider="{{ provider }}">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="h4 mb-0 provider-badge provider-{{ provider|lower }}">
      {{ provider }}
    </h2>
    <small class="text-muted">{{ items|length }} partidos</small>
  </div>

  <div class="table-responsive shadow-sm rounded">
    <table class="table table-dark table-striped provider-table" data-page-size="10">
      <thead>
        <tr>
          <th>Fecha/Hora</th>
          <th>Partido</th>
          <th>Liga</th>
          <th class="text-end">Ver</th>
        </tr>
      </thead>

      <tbody>

        {% for event in items %}
        <tr>

          <!-- FECHA/HORA -->
          <td>
            {% if event.match_time %}
            {{ event.match_time }}
            {% elif event.date_text %}
            {{ event.date_text }}
            {% else %}
            <!-- fallback para Kakarotfoot -->
            {{ event.start_time | datetime }}
            {% endif %}
          </td>

          <!-- PARTIDO -->
          <td>
            {{ event.home }}
            {% if event.away %}
            <span class="text-danger">vs</span> {{ event.away }}
            {% endif %}
          </td>

          <!-- LIGA -->
          <td>{{ event.league or provider }}</td>

          <!-- BOTÓN VER STREAM -->
          <td class="text-end">

            <!-- Para LiveTV SIEMPRE debe ser lazy -->
            {% if provider.lower() == "livetv" %}
            <a href="/stream?event={{ event.id | urlencode }}&source=LiveTV" class="btn btn-primary btn-sm">
              Ver streaming →
            </a>

            {% else %}
            <!-- Otros sitios sí pueden tener streams -->
            {% if event.streams and event.streams|length > 0 %}
            <a href="/stream?url={{ event.streams[0].url | urlencode }}
                           &source={{ event.provider | urlencode }}
                           &event={{ event.id | urlencode }}" class="btn btn-primary btn-sm">
              Ver streaming →
            </a>
            {% endif %}
            {% endif %}

          </td>

        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>

  <!-- PAGINACIÓN -->
  <div class="pagination-controls d-flex justify-content-end gap-2 mt-2">
    <button class="btn btn-sm btn-outline-light prev-page">«</button>
    <span class="page-info small">Página 1</span>
    <button class="btn btn-sm btn-outline-light next-page">»</button>
  </div>

</section>
{% endfor %}

{% endblock %}